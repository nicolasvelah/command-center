stages:
  - buildForTest
  - test
  - build
  - review
  - staging
  - production

variables:
  npm_config_cache: '$CI_PROJECT_DIR/.npm'
  CYPRESS_CACHE_FOLDER: '$CI_PROJECT_DIR/cache/Cypress'

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .npm
    - cache/Cypress
    - node_modules

install-dependencies:
  image: cypress/base:10
  stage: buildForTest
  script:
    - npm install
  artifacts:
    expire_in: 1hr
    paths:
      - node_modules/
      - npm ci
      - $(npm bin)/print-env CI
      - npm run cy:verify
  cache:
    paths:
      - node_modules/
  only:
    - branches
  except:
    - master
    - staging

test-apps:
  image: cypress/browsers:chrome67
  stage: test
  script:
    - npm ci
    - npm run test:e2e:ci
  artifacts:
    expire_in: 1 week
    when: always
    paths:
      - cypress/screenshots
      - cypress/videos
  only:
    - branches
  except:
    - master
    - staging

build-app:
  image: node:10.14.2
  stage: build
  variables:
    BUILD_CONFIGURATION: 'production'
  dependencies:
    - install-dependencies
  script:
    - npm run build
  artifacts:
    expire_in: 1hr
    paths:
      - public/
  except:
    - master
    - staging

code_quality:
  image: docker:stable
  variables:
    DOCKER_DRIVER: overlay2
  allow_failure: true
  services:
    - docker:stable-dind
  script:
    - export SP_VERSION=$(echo "$CI_SERVER_VERSION" | sed 's/^\([0-9]*\)\.\([0-9]*\).*/\1-\2-stable/')
    - docker run
      --env SOURCE_CODE="$PWD"
      --volume "$PWD":/code
      --volume /var/run/docker.sock:/var/run/docker.sock
      "registry.gitlab.com/gitlab-org/security-products/codequality:$SP_VERSION" /code
  artifacts:
    reports:
      codequality: gl-code-quality-report.json
  except:
    - master
    - staging

review:
  stage: review
  script:
    - command deploy
  environment:
    name: review/$CI_BUILD_REF_NAME
    url: https://$CI_ENVIRONMENT_SLUG.$KUBE_DOMAIN
    on_stop: stop_review
  only:
    - branches
  except:
    - master
    - staging

stop_review:
  stage: review
  variables:
    GIT_STRATEGY: none
  script:
    - command destroy
  environment:
    name: review/$CI_BUILD_REF_NAME
    action: stop
  when: manual
  only:
    - branches
  except:
    - master
    - staging

deploy-staging:
  image: ubuntu:16.04
  stage: staging
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client git -y )'
    - eval $(ssh-agent -s)

    ##
    ## Add the SSH key stored in SSH_PRIVATE_KEY variable to the agent store
    ## We're using tr to fix line endings which makes ed25519 keys work
    ## without extra base64 encoding.
    ## https://gitlab.com/gitlab-examples/ssh-private-key/issues/1#note_48526556
    ##
    - echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDVKk2qaO3CfXAeze1CcQ44lzvJ+7pLMkN1g2Gld0Lo5gyGrZEJjjJtVSUx3sWyIONKEABtPdQUVxr8xhfAfg4R9RNtPQuTErjH4pnCNn/G4oa7AUtwAlNVQaBAle7GH0zoztnzD+TPPRB7T6n2MqWvM0cyzoO3y/anxXD5hOvKZYSSXYaHq8zh5Kywp7FlvBU5Bggms2/5Q4ud1hjmivk4nr1gD8se94fCkKC2tMU2WNVGnyoWHzOgygsXhyGQDYzwQIXoYHpDu2d4bLDxSZYEpuL02TAI4tcgwOgzpyhJ1CD3nd4fM6q2PmJcJi9vha8LzLCxiEKjL+pU+kVwtyIKXCwSUQDte9EgdPEgTlMazPd+sVl9IIt/TjAS+cYXAMuf8ha455NoaT+YKqJIxjSSQvu3xMI4F/Mx3JfpquH0VT1S3oe0IxHgQevxv+cuURSFVwUXltYp7PwHFm8VLEFM2Xm850X42LnDxhuUFKhVa8Y2p2E2YbBs4ELbM8rMC6aPlFS7y9Fj/Hvb4oE7S37yi8/MhKAVJh5DQLbXRwgsif+xe249N2nnzjUdzfAl2ZEJ8dA+tmzeziWlQOzYF5KUkDREEJatouiqclRdSguZKp5VcozzCZS1a9+CtVnz4LkA6/zHK6dbDbSWjSkZJlWJZ4tLY3nA5sqDGaMAo7OSsw== gitlab@pas-hq.com" | tr -d '\r' | ssh-add - > /dev/null

    ##
    ## Create the SSH directory and give it the right permissions
    ##
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh

    ##
    ## Use ssh-keyscan to scan the keys of your private server. Replace gitlab.com
    ## with your own domain name. You can copy and repeat that command if you have
    ## more than one server to connect to.
    ##
    - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh dev@167.99.173.145
  environment:
    name: staging
    url: https://cc.it-zam.com
  only:
    - staging

deploy-production:
  image: node:10.14.2
  stage: production
  dependencies:
    - build-app
  script:
    - rsync -avuz -e 'ssh -i ~/.ssh/id_rsa' $CI_PROJECT_DIR/public/ dev@167.99.173.145:/var/www/cc
  environment:
    name: production
    url: https://cc.itzam.ec
  only:
    - master
